#!/usr/bin/env bash
set -euo pipefail

# Function to check if a command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Install pipx if not already available
if ! command_exists pipx; then
    echo "Installing pipx..."
    brew install pipx || python3 -m pip install --user pipx
    pipx ensurepath
fi

# Upgrade/install Python CLI tools with pipx
echo "Installing/upgrading Python CLI tools with pipx..."
pipx install --include-deps stormssh || true
pipx upgrade stormssh || true

# Vim + Vundle (optional — comment out if moving to nvim or modern manager)
# if [[ ! -d "$HOME/.vim/bundle/Vundle.vim" ]]; then
#     echo "Installing Vundle for Vim..."
#     git clone https://github.com/VundleVim/Vundle.vim "$HOME/.vim/bundle/Vundle.vim"
# fi
# vim +PluginInstall +qall || echo "Vim plugins: some issues, continuing..."

# # Change default shell to Fish (idempotent — skips if already set)
if [[ "$SHELL" != */fish ]]; then
    echo "Changing default shell to Fish..."
    FISH_PATH="$(which fish)"
    if ! grep -q "^$FISH_PATH\$" /etc/shells; then
        echo "Adding Fish to /etc/shells..."
        echo "$FISH_PATH" | sudo tee -a /etc/shells
    fi
    sudo chsh -s "$FISH_PATH" "$USER"
else
    echo "Default shell is already Fish, skipping..."
fi

# Install Fisher (Fish plugin manager) — robust bash-compatible version
if ! fish -c 'functions -q fisher' 2>/dev/null; then
    echo "Installing Fisher..."
    curl -sL https://git.io/fisher | fish
else
    echo "Fisher already installed"
fi

# Install and update Fisher plugins
echo "Installing/updating Fisher plugins..."
fish -c "
    fisher install jorgebucaran/fisher
    fisher install markcial/upto
    fisher install danhper/fish-ssh-agent
    fisher install edc/bass
    fisher install evanlucas/fish-kubectl-completions
    fisher install fisherman/spin
    fisher install halostatue/fish-direnv
    fisher install laughedelic/pisces
    fisher install oh-my-fish/plugin-bang-bang
    fisher install oh-my-fish/plugin-expand
    fisher install tuvistavie/fish-fastdir
    fisher install z11i/github-copilot-cli.fish
    fisher install joseluisq/gitnow
    fisher install ilancosman/tide@v6

    fisher update
" || echo "Some Fisher operations had issues, continuing..."

# zoxide (safety net if not in brew.formula)
if ! command_exists zoxide; then
    brew install zoxide || true
fi

# yadm: install and clone/pull dotfiles
if ! command_exists yadm; then
    echo "Installing yadm..."
    brew install yadm || true
fi

if [[ ! -f "$HOME/.gitconfig" ]] && [[ ! -d "$HOME/.config/fish" ]]; then
    echo "Cloning dotfiles with yadm..."
    yadm clone git@github.com:markshields/dotfiles.git
else
    echo "Dotfiles already present, pulling latest..."
    yadm pull
fi

# Post-clone: init zoxide + fisher update
echo "Post-clone setup..."
fish -c "zoxide init fish | source; fisher update || true"

# --- Keep your other tool installs below (unchanged/active ones) ---
# krew
if ! command_exists kubectl-krew; then
    echo "Installing krew..."
    (
        set -x; cd "$(mktemp -d)" &&
        OS="darwin" &&
        ARCH="arm64" &&
        KREW="krew-darwin_arm64" &&
        curl -fsSLO "https://github.com/kubernetes-sigs/krew/releases/latest/download/${KREW}.tar.gz" &&
        tar zxvf "${KREW}.tar.gz" &&
        ./"${KREW}" install krew
    )
fi
kubectl-krew update
kubectl-krew upgrade || true
kubectl-krew install ctx ns ingress-nginx minio neat konfig cert-manager sniff || true

# gcpdiag
if ! command_exists gcpdiag; then
    curl https://gcpdiag.dev/gcpdiag.sh -o "$HOME/.local/bin/gcpdiag"
    chmod +x "$HOME/.local/bin/gcpdiag"
fi

# asciicast2movie
if ! python3 -c "import asciicast2movie" 2>/dev/null; then
    python3 -m pip install asciicast2movie || true
fi

# cmctl
if ! command_exists cmctl; then
    OS="darwin"; ARCH="arm64"
    LATEST_CMCTL_TAG=$(curl -s https://api.github.com/repos/cert-manager/cert-manager/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
    [ -z "$LATEST_CMCTL_TAG" ] && LATEST_CMCTL_TAG="v1.7.2"
    curl -sSL -o cmctl.tar.gz "https://github.com/cert-manager/cert-manager/releases/download/$LATEST_CMCTL_TAG/cmctl-$OS-$ARCH.tar.gz"
    tar xzf cmctl.tar.gz
    mv cmctl "$HOME/.local/bin/"
fi

# jsonwebtokencli (via npm/Volta)
if ! command_exists jwt; then
    npm install --global jsonwebtokencli || true
fi

# git-prune-branches script
if [[ ! -f "$HOME/.local/bin/git-prune-branches" ]]; then
    mkdir -p "$HOME/.local/bin"
    echo -e "#!/usr/bin/env bash\nset -euxo pipefail\ngit branch --merged | grep -v '*' | xargs git branch -d || true" > "$HOME/.local/bin/git-prune-branches"
    chmod +x "$HOME/.local/bin/git-prune-branches"
fi

# terraform-config-inspect
if ! command_exists terraform-config-inspect; then
    go install github.com/hashicorp/terraform-config-inspect@latest || true
fi

# Volta
if ! command_exists volta; then
    curl https://get.volta.sh | bash
fi

# Claude CLI
if ! command_exists claude; then
    curl -fsSL claude.ai/install.sh | bash || true
fi

# Cursor
if ! command_exists cursor; then
    curl https://cursor.com/install -fsS | bash || true
fi

echo "Setup complete! Restart your terminal or run 'exec fish'."
