#!/usr/bin/env bash
set -euo pipefail

# Function to check if a command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Upgrade Python packages (keep only what you use)
echo "Upgrading Python packages..."
python3 -m pip install --upgrade \
  stormssh || echo "Failed some Python upgrades, continuing..."

# Vim + Vundle (keep if you still use classic Vim; comment out if moving to nvim/Cursor)
if [[ ! -d "$HOME/.vim/bundle/Vundle.vim" ]]; then
    echo "Installing Vundle for Vim..."
    git clone https://github.com/VundleVim/Vundle.vim "$HOME/.vim/bundle/Vundle.vim"
fi
vim +PluginInstall +qall || echo "Vim plugins: some issues, continuing..."

# Change shell to Fish
if [[ "$SHELL" != */fish ]]; then
    echo "Changing default shell to Fish..."
    FISH_PATH="$(which fish)"
    sudo grep -q "$FISH_PATH" /etc/shells || echo "$FISH_PATH" | sudo tee -a /etc/shells
    sudo chsh -s "$FISH_PATH" "$USER"
fi

# Install Fisher (Fish plugin manager)
if ! fish -c 'functions -q fisher' 2>/dev/null; then
    echo "Installing Fisher..."
    curl -sL https://git.io/fisher | source && fisher install jorgebucaran/fisher
else
    echo "Fisher already installed"
fi

# Install/update your current Fish plugins (uncomment/add your actual list)
echo "Updating Fisher plugins..."
fish -c "fisher update" || echo "Fisher update issues, continuing..."

# Example modern plugins (replace with yours):
# fisher install IlanCosman/tide
# fisher install jorgebucaran/nvm.fish
# fisher install meaningful-ooo/sponge
# etc.

# zoxide (if not in brew.formula already — redundant safety)
if ! command_exists zoxide; then
    brew install zoxide
fi

# yadm: install and clone your dotfiles repo (the big modern change)
if ! command_exists yadm; then
    echo "Installing yadm..."
    brew install yadm
fi

if [[ ! -f "$HOME/.gitconfig" ]] && [[ ! -d "$HOME/.config/fish" ]]; then  # rough check if dotfiles are present
    echo "Cloning dotfiles with yadm..."
    yadm clone git@github.com:markshields/dotfiles.git
else
    echo "Dotfiles already present, pulling latest..."
    yadm pull
fi

# Post-clone setup
echo "Post-clone setup..."
exec fish -c "zoxide init fish | source; fisher update || true"

# Keep your other tool installs (krew, gcpdiag, cmctl, jwt, git-prune-branches, terraform-config-inspect, volta, claude, cursor)
# ... (the rest of your original generic script is unchanged — I kept the active sections below for completeness)

# krew
if ! command_exists kubectl-krew; then
    echo "Installing krew..."
    (
        set -x; cd "$(mktemp -d)" &&
        OS="$(uname | tr '[:upper:]' '[:lower:]')" &&
        ARCH="$(uname -m | sed -e 's/x86_64/amd64/' -e 's/\(arm\)\(64\)\?.*/\1\2/' -e 's/aarch64$/arm64/')" &&
        KREW="krew-${OS}_${ARCH}" &&
        curl -fsSLO "https://github.com/kubernetes-sigs/krew/releases/latest/download/${KREW}.tar.gz" &&
        tar zxvf "${KREW}.tar.gz" &&
        ./"${KREW}" install krew
    )
fi
kubectl-krew update
kubectl-krew upgrade || true
kubectl-krew install ctx ns ingress-nginx minio neat konfig cert-manager sniff || true

# gcpdiag, asciicast2movie, cmctl, jwt, git-prune-branches, terraform-config-inspect, volta, claude, cursor
# (copy-paste your original blocks here — they look fine)

echo "Setup complete! Restart your terminal or run 'exec fish'."