#!/usr/bin/env bash
# Setup script for macOS (Apple Silicon only) â€” modernized for yadm + zoxide

set -euo pipefail

# Function to check if a command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Install Homebrew if not already installed
if ! command_exists brew; then
    echo "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
else
    echo "Homebrew already installed, updating..."
    brew update
fi

# Activate Homebrew in current session and .zprofile
echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> "$HOME/.zprofile"
eval "$(/opt/homebrew/bin/brew shellenv)"

# Install/update all formulae (one file for Silicon)
echo "Installing/updating formulae from brew.formula..."
xargs brew install < brew.formula || true

# Install/update casks
echo "Installing/updating casks from brew.casks..."
xargs brew install --cask < brew.casks || true

# Homebrew autoupdate
if ! brew tap | grep -q "homebrew/autoupdate"; then
    brew tap homebrew/autoupdate
fi
if ! brew autoupdate status | grep -q "Autoupdate is enabled"; then
    brew autoupdate start
fi

# instrumenta tap (if still needed)
if ! brew tap | grep -q "instrumenta/instrumenta"; then
    brew tap instrumenta/instrumenta
fi

# Create local bin
mkdir -p "$HOME/.local/bin"

# Execute generic setup
echo "Executing generic setup script..."
exec ./setup-generic